<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Super Padel Zamora</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #1a73e8;
    }
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls input {
      padding: 10px;
      font-size: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 1000px;
      margin: auto;
    }
    .court-column {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
    }
    .court-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #1a73e8;
    }
    .slot {
      background: #fff;
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #ccc;
      margin-bottom: 5px;
      cursor: pointer;
    }
    .slot.booked {
      background: #ddd;
      color: #999;
      cursor: not-allowed;
    }
    #formContainer,
    #categoryModal,
    #playersModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }
    .formBox {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .formBox input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .formBox button {
      padding: 10px 20px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .formBox button.selected {
      background-color: #4caf50;
    }
	#playersList {
	  display: grid;
	  grid-template-columns: repeat(2, 1fr);
	  gap: 10px;
	  margin-top: 10px;
	  margin-bottom: 10px;
	}
	#leagueFinishButton {
	  width: 100%;
	  background: #4caf50;
	}
	.cancel-button {
	  background-color: #ccc;
	  color: black;
	  width: 100%;
	  margin-top: 10px;
	}
  </style>
</head>
<body>
  <h1>Super Padel Zamora</h1>
  <div class="controls">
    <input type="date" id="datePicker" />
  </div>
  <div class="grid" id="bookingGrid"></div>

  <!-- Booking Form -->
  <div id="formContainer">
    <div class="formBox">
  	<h3>Reserva un Horario</h3>
  	<input type="text" id="name" placeholder="Nombre de la Reserva" />
  	<input type="text" id="phone" placeholder="Numero de Telefono" />
  	<button onclick="submitBooking()">RESERVAR</button>
  	<button onclick="showCategoryModal()">JUEGO DE LIGA</button>
  	<button class="cancel-button" onclick="closeAllModals()">Salir</button>
    </div>
  </div>

  <!-- Category Modal -->
  <div id="categoryModal">
    <div class="formBox">
      <h3>Selecciona la Categoria</h3>
      <button onclick="selectCategory('4A')">4ta Grupo A</button>
      <button onclick="selectCategory('4B')">4ta Grupo B</button>
      <button onclick="selectCategory('5A')">5ta Grupo A</button>
      <button onclick="selectCategory('5B')">5ta Grupo B</button>
      <button onclick="selectCategory('Mixed')">Mixta</button>
      <button class="cancel-button" onclick="closeAllModals()">Cancelar</button>
    </div>
  </div>

  <!-- Players Modal -->
  <div id="playersModal">
    <div class="formBox">
      <h3>Selecciona las 2 Parejas</h3>
      <div id="playersList"></div>
      <button id="leagueFinishButton" onclick="finishLeagueBooking()" style="display:none;">RESERVAR</button>
      <button class="cancel-button" onclick="closeAllModals()">Cancelar</button>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, get } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

    const { DateTime } = luxon;
    const TZ = 'America/Mexico_City';

    const firebaseConfig = {
      apiKey: "AIzaSyBOq0oFBM791lCs9th8wkVTGSHvLR1k_Hc",
      authDomain: "reservas-superpadel.firebaseapp.com",
      databaseURL: "https://reservas-superpadel-default-rtdb.firebaseio.com",
      projectId: "reservas-superpadel",
      storageBucket: "reservas-superpadel.appspot.com",
      messagingSenderId: "736124396684",
      appId: "1:736124396684:web:c0f3921a2b1ba354bcc7a9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const bookingGrid = document.getElementById('bookingGrid');
    const datePicker = document.getElementById('datePicker');
    const bookedSlots = new Set();
    const courts = [1, 2, 3];
    const times = [
      "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00",
      "14:00", "15:00", "16:00", "17:00", "18:00", "19:00",
      "20:00", "21:00", "22:00", "23:00"
    ];

    const todayMX = DateTime.now().setZone(TZ);
    datePicker.value = todayMX.toISODate();
    const maxDate = todayMX.plus({ days: 7 }).toISODate();
    datePicker.min = todayMX.toISODate();
    datePicker.max = maxDate;
    datePicker.addEventListener('change', buildGrid);

    onValue(ref(db, 'bookings/'), snapshot => {
      bookedSlots.clear();
      const data = snapshot.val();
      if (data) {
        Object.values(data).forEach(({ date, time, court }) => {
          bookedSlots.add(`${date}_${time}_Court${court}`);
        });
      }
      buildGrid();
    });

    function buildGrid() {
      const selectedDate = datePicker.value;
      bookingGrid.innerHTML = '';
      if (!selectedDate) return;
      courts.forEach(court => {
        const column = document.createElement('div');
        column.className = 'court-column';
        const title = document.createElement('div');
        title.className = 'court-title';
        title.textContent = `Cancha ${court}`;
        column.appendChild(title);
        times.forEach(time => {
		  const key = `${selectedDate}_${time}_Court${court}`;
		  const slot = document.createElement('div');
		  slot.className = 'slot';
		  slot.textContent = time;

		  const now = DateTime.now().setZone(TZ);
		  const slotDateTime = DateTime.fromISO(`${selectedDate}T${time}`, { zone: TZ });

		  // ðŸš« Skip if today and time is in the past (with 15-minute buffer)
		  const isToday = selectedDate === now.toISODate();
		  const isPast = slotDateTime <= now.plus({ minutes: 15 });

		  if (bookedSlots.has(key)) {
			slot.classList.add('booked');
			column.appendChild(slot); // âœ… Always show reserved slots
		  } else if (!(isToday && isPast)) {
			slot.onclick = () => openForm(key);
			column.appendChild(slot); // âœ… Show only if it's not past
		  }
		});

        bookingGrid.appendChild(column);
      });
    }

    let currentSlot = null;
    let selectedTeams = [];

    function openForm(slotKey) {
      currentSlot = slotKey;
      selectedTeams = [];
      document.getElementById('formContainer').style.display = 'flex';
    }

    window.submitBooking = async function () {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if (!name || !phone || !currentSlot) return alert('Por Favor llena el nombre y un numero de telefono.');
      const [date, time, courtPart] = currentSlot.split('_');
      const court = courtPart.replace('Cancha', '');
      await push(ref(db, 'bookings/'), {
        timestamp: DateTime.now().setZone(TZ).toISO(),
        name,
        phone,
        date,
        time,
        court,
        type: 'regular'
      });
      alert(`Reserva Completada Cancha ${court} ${time} ${date}`);
      bookedSlots.add(currentSlot);
      document.getElementById('formContainer').style.display = 'none';
      buildGrid();
    };

    window.showCategoryModal = function () {
      document.getElementById('formContainer').style.display = 'none';
      document.getElementById('categoryModal').style.display = 'flex';
    };

    window.selectCategory = async function (category) {
      document.getElementById('categoryModal').style.display = 'none';
      const snapshot = await get(ref(db, `players/${category}`));
      const players = snapshot.val();
      const listDiv = document.getElementById('playersList');
      listDiv.innerHTML = '';
      selectedTeams = [];
      if (!players) return;
      Object.values(players).forEach(player => {
        const btn = document.createElement('button');
        btn.textContent = player;
        btn.onclick = () => toggleTeamSelection(btn, player);
        listDiv.appendChild(btn);
      });
      document.getElementById('playersModal').style.display = 'flex';
    };

    function toggleTeamSelection(button, player) {
      const index = selectedTeams.indexOf(player);
      if (index > -1) {
        selectedTeams.splice(index, 1);
        button.classList.remove('selected');
      } else if (selectedTeams.length < 2) {
        selectedTeams.push(player);
        button.classList.add('selected');
      }
      document.getElementById('leagueFinishButton').style.display = selectedTeams.length === 2 ? 'inline-block' : 'none';
    }

    window.finishLeagueBooking = async function () {
      if (selectedTeams.length !== 2 || !currentSlot) return alert('Por Favor Selecciona las 2 parejas que jugaran.');
      const [date, time, courtPart] = currentSlot.split('_');
      const court = courtPart.replace('Cancha', '');
      await push(ref(db, 'bookings/'), {
        timestamp: DateTime.now().setZone(TZ).toISO(),
        name: 'LEAGUE GAME',
        team1: selectedTeams[0],
        team2: selectedTeams[1],
        date,
        time,
        court,
        type: 'league'
      });
      alert(`JUEGO DE LIGA listo! ${selectedTeams[0]} vs ${selectedTeams[1]}`);
      bookedSlots.add(currentSlot);
      document.getElementById('playersModal').style.display = 'none';
      document.getElementById('formContainer').style.display = 'none';
      buildGrid();
    };
	
	window.closeAllModals = function () {
	  document.getElementById('formContainer').style.display = 'none';
	  document.getElementById('categoryModal').style.display = 'none';
	  document.getElementById('playersModal').style.display = 'none';
	};
  </script>
</body>
</html>
